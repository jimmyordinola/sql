import pandas as pd
from io import StringIO
from datetime import datetime

# Datos de ENTRADAS (copiados de la consulta SQL)
entradas_data = """Cd_Inv	Item	Costo_MN	Cantidad	IC_ES	FechaMovimiento
INV000286867	4	19.82273000000000000000	1.00000000000000000000	E	2025-04-01 06:11:00.000
INV000301301	32	19.82273000000000000000	8.00000000000000000000	E	2025-04-01 11:26:00.000
INV000301302	46	19.82273000000000000000	8.00000000000000000000	E	2025-04-01 11:26:01.000
INV000301300	36	19.82273000000000000000	6.00000000000000000000	E	2025-04-01 14:58:42.720
INV000301304	24	19.82273000000000000000	4.00000000000000000000	E	2025-04-01 15:03:01.000
INV000306653	44	19.82273000000000000000	11.00000000000000000000	E	2025-04-02 05:23:00.000
INV000247006	46	19.82273000000000000000	13.00000000000000000000	E	2025-04-02 09:10:34.970
INV000247008	32	19.82273000000000000000	2.00000000000000000000	E	2025-04-02 09:15:46.740
INV000301306	34	19.82273000000000000000	10.00000000000000000000	E	2025-04-02 15:29:00.000
INV000300554	4	16.98368690000000000000	82.00000000000000000000	E	2025-04-02 23:00:00.000
INV000287071	34	19.82273000000000000000	3.00000000000000000000	E	2025-04-03 06:24:00.000
INV000287062	44	19.82273000000000000000	14.00000000000000000000	E	2025-04-03 06:29:00.000
INV000247030	50	19.82273000000000000000	2.00000000000000000000	E	2025-04-03 07:44:31.587
INV000247033	42	19.82273000000000000000	17.00000000000000000000	E	2025-04-03 08:04:03.187
INV000300553	4	16.58974640000000000000	51.00000000000000000000	E	2025-04-03 09:30:00.000
INV000301307	36	19.82273000000000000000	10.00000000000000000000	E	2025-04-03 15:43:00.000
INV000306650	16	19.82273000000000000000	7.00000000000000000000	E	2025-04-03 17:51:00.000
INV000287063	34	19.82273000000000000000	4.00000000000000000000	E	2025-04-04 01:24:00.000
INV000247074	42	19.82273000000000000000	11.00000000000000000000	E	2025-04-04 08:04:24.133
INV000247075	48	19.82273000000000000000	7.00000000000000000000	E	2025-04-04 08:06:26.280
INV000247076	44	19.82273000000000000000	7.00000000000000000000	E	2025-04-04 08:20:42.477
INV000247078	26	19.82273000000000000000	6.00000000000000000000	E	2025-04-04 08:36:07.130
INV000306647	6	19.82273000000000000000	1.00000000000000000000	E	2025-04-04 10:22:00.000
INV000286903	44	19.82273000000000000000	10.00000000000000000000	E	2025-04-04 17:07:51.750
INV000286875	8	19.82273000000000000000	2.00000000000000000000	E	2025-04-05 06:43:00.000
INV000286876	8	19.82273000000000000000	3.00000000000000000000	E	2025-04-05 08:51:00.000
INV000286894	50	19.82273000000000000000	6.00000000000000000000	E	2025-04-05 13:24:51.600
INV000286896	52	19.82273000000000000000	9.00000000000000000000	E	2025-04-05 13:28:56.277
INV000286897	56	19.82273000000000000000	14.00000000000000000000	E	2025-04-05 13:38:12.760
INV000286898	40	19.82273000000000000000	4.00000000000000000000	E	2025-04-05 13:41:43.660
INV000287005	50	19.82273000000000000000	12.00000000000000000000	E	2025-04-06 09:06:00.000
INV000287010	34	19.82273000000000000000	8.00000000000000000000	E	2025-04-06 09:21:00.000
INV000286993	50	19.82273000000000000000	18.00000000000000000000	E	2025-04-06 10:17:07.990
INV000286994	40	19.82273000000000000000	16.00000000000000000000	E	2025-04-06 10:31:31.313
INV000286999	52	19.82273000000000000000	30.00000000000000000000	E	2025-04-06 11:02:22.593
INV000301246	38	19.82273000000000000000	3.00000000000000000000	E	2025-04-07 07:35:59.450
INV000247199	24	19.82273000000000000000	6.00000000000000000000	E	2025-04-07 08:08:00.000
INV000247198	32	19.82273000000000000000	6.00000000000000000000	E	2025-04-07 08:22:00.000
INV000247205	36	19.82273000000000000000	3.00000000000000000000	E	2025-04-07 09:03:00.000
INV000306642	34	19.82273000000000000000	8.00000000000000000000	E	2025-04-07 09:49:30.027
INV000300555	4	16.58969240000000000000	60.00000000000000000000	E	2025-04-07 15:30:00.000
INV000247208	46	19.82273000000000000000	1.00000000000000000000	E	2025-04-08 07:47:00.000
INV000247220	44	19.82273000000000000000	10.00000000000000000000	E	2025-04-08 07:56:00.000
INV000247223	32	19.82273000000000000000	3.00000000000000000000	E	2025-04-08 08:13:00.000
INV000247224	20	19.82273000000000000000	3.00000000000000000000	E	2025-04-08 09:34:31.383
INV000300558	4	16.09514660000000000000	31.00000000000000000000	E	2025-04-08 16:00:01.000
INV000287065	34	19.82273000000000000000	7.00000000000000000000	E	2025-04-08 23:36:00.000
INV000247273	42	19.82273000000000000000	4.00000000000000000000	E	2025-04-09 07:46:00.000
INV000247274	42	19.82273000000000000000	6.00000000000000000000	E	2025-04-09 07:50:00.000
INV000247279	40	19.82273000000000000000	4.00000000000000000000	E	2025-04-09 07:56:00.000
INV000247281	34	19.82273000000000000000	8.00000000000000000000	E	2025-04-09 08:03:00.000
INV000247282	26	19.82273000000000000000	3.00000000000000000000	E	2025-04-09 08:09:00.000
INV000301310	20	19.82273000000000000000	9.00000000000000000000	E	2025-04-09 10:58:00.000
INV000247283	4	19.82273000000000000000	2.00000000000000000000	E	2025-04-09 11:25:00.000
INV000300559	4	0.45212100000000000000	29.00000000000000000000	E	2025-04-09 16:30:00.000
INV000247306	42	19.82273000000000000000	9.00000000000000000000	E	2025-04-10 07:09:00.000
INV000247307	36	19.82273000000000000000	7.00000000000000000000	E	2025-04-10 08:01:00.000
INV000247319	40	19.82273000000000000000	2.00000000000000000000	E	2025-04-10 08:17:00.000
INV000247326	32	19.82273000000000000000	5.00000000000000000000	E	2025-04-10 08:22:00.000
INV000247317	44	19.82273000000000000000	10.00000000000000000000	E	2025-04-10 09:32:27.730
INV000306643	20	19.82273000000000000000	5.00000000000000000000	E	2025-04-10 09:55:22.370
INV000300564	4	20.59786610000000000000	118.00000000000000000000	E	2025-04-10 13:30:01.000
INV000247379	44	19.82273000000000000000	6.00000000000000000000	E	2025-04-11 08:42:00.000
INV000247376	44	19.82273000000000000000	9.00000000000000000000	E	2025-04-11 08:48:15.240
INV000300582	4	28.03433260000000000000	44.00000000000000000000	E	2025-04-11 09:00:01.000
INV000247382	52	19.82273000000000000000	12.00000000000000000000	E	2025-04-11 09:03:00.000
INV000247384	36	19.82273000000000000000	8.00000000000000000000	E	2025-04-11 09:22:00.000
INV000287025	32	19.82273000000000000000	1.00000000000000000000	E	2025-04-11 16:37:40.440"""

# Datos de SALIDAS (copiados de la consulta SQL) - Solo primeras para demostración
salidas_data = """Cd_Inv	Item	Costo_MN	Cantidad	IC_ES	FechaMovimiento
INV000286867	3	19.82273000000000000000	1.00000000000000000000	S	2025-04-01 06:11:00.000
INV000301301	31	19.82273000000000000000	8.00000000000000000000	S	2025-04-01 11:26:00.000
INV000301302	45	19.82273000000000000000	8.00000000000000000000	S	2025-04-01 11:26:01.000
INV000301300	35	19.82273000000000000000	6.00000000000000000000	S	2025-04-01 14:58:42.720
INV000301304	23	19.82273000000000000000	4.00000000000000000000	S	2025-04-01 15:03:01.000
INV000306653	43	19.82273000000000000000	11.00000000000000000000	S	2025-04-02 05:23:00.000
INV000247006	45	19.82273000000000000000	13.00000000000000000000	S	2025-04-02 09:10:34.970
INV000247008	31	19.82273000000000000000	2.00000000000000000000	S	2025-04-02 09:15:46.740
INV000301306	33	19.82273000000000000000	10.00000000000000000000	S	2025-04-02 15:29:00.000
INV000287071	33	19.82273000000000000000	3.00000000000000000000	S	2025-04-03 06:24:00.000
INV000287062	43	19.82273000000000000000	14.00000000000000000000	S	2025-04-03 06:29:00.000
INV000247030	49	19.82273000000000000000	2.00000000000000000000	S	2025-04-03 07:44:31.587
INV000247033	41	19.82273000000000000000	17.00000000000000000000	S	2025-04-03 08:04:03.187
INV000301307	35	19.82273000000000000000	10.00000000000000000000	S	2025-04-03 15:43:00.000
INV000306650	15	19.82273000000000000000	7.00000000000000000000	S	2025-04-03 17:51:00.000
INV000287063	33	19.82273000000000000000	4.00000000000000000000	S	2025-04-04 01:24:00.000
INV000247074	41	19.82273000000000000000	11.00000000000000000000	S	2025-04-04 08:04:24.133
INV000247075	47	19.82273000000000000000	7.00000000000000000000	S	2025-04-04 08:06:26.280
INV000247076	43	19.82273000000000000000	7.00000000000000000000	S	2025-04-04 08:20:42.477
INV000247078	25	19.82273000000000000000	6.00000000000000000000	S	2025-04-04 08:36:07.130
INV000306647	5	19.82273000000000000000	1.00000000000000000000	S	2025-04-04 10:22:00.000
INV000286903	43	19.82273000000000000000	10.00000000000000000000	S	2025-04-04 17:07:51.750
INV000286875	7	19.82273000000000000000	2.00000000000000000000	S	2025-04-05 06:43:00.000
INV000286876	7	19.82273000000000000000	3.00000000000000000000	S	2025-04-05 08:51:00.000
INV000286894	49	19.82273000000000000000	6.00000000000000000000	S	2025-04-05 13:24:51.600
INV000286896	51	19.82273000000000000000	9.00000000000000000000	S	2025-04-05 13:28:56.277
INV000286897	55	19.82273000000000000000	14.00000000000000000000	S	2025-04-05 13:38:12.760
INV000286898	39	19.82273000000000000000	4.00000000000000000000	S	2025-04-05 13:41:43.660
INV000287005	49	19.82273000000000000000	12.00000000000000000000	S	2025-04-06 09:06:00.000
INV000287010	33	19.82273000000000000000	8.00000000000000000000	S	2025-04-06 09:21:00.000
INV000286993	49	19.82273000000000000000	18.00000000000000000000	S	2025-04-06 10:17:07.990
INV000286994	39	19.82273000000000000000	16.00000000000000000000	S	2025-04-06 10:31:31.313
INV000286999	51	19.82273000000000000000	30.00000000000000000000	S	2025-04-06 11:02:22.593
INV000301246	37	19.82273000000000000000	3.00000000000000000000	S	2025-04-07 07:35:59.450
INV000247199	23	19.82273000000000000000	6.00000000000000000000	S	2025-04-07 08:08:00.000
INV000247198	31	19.82273000000000000000	6.00000000000000000000	S	2025-04-07 08:22:00.000
INV000247205	35	19.82273000000000000000	3.00000000000000000000	S	2025-04-07 09:03:00.000
INV000306642	33	19.82273000000000000000	8.00000000000000000000	S	2025-04-07 09:49:30.027
INV000247208	45	19.82273000000000000000	1.00000000000000000000	S	2025-04-08 07:47:00.000
INV000247220	43	19.82273000000000000000	10.00000000000000000000	S	2025-04-08 07:56:00.000
INV000247223	31	19.82273000000000000000	3.00000000000000000000	S	2025-04-08 08:13:00.000
INV000247224	19	19.82273000000000000000	3.00000000000000000000	S	2025-04-08 09:34:31.383
INV000287065	33	19.82273000000000000000	7.00000000000000000000	S	2025-04-08 23:36:00.000
INV000247273	41	19.82273000000000000000	4.00000000000000000000	S	2025-04-09 07:46:00.000
INV000247274	41	19.82273000000000000000	6.00000000000000000000	S	2025-04-09 07:50:00.000
INV000247279	39	19.82273000000000000000	4.00000000000000000000	S	2025-04-09 07:56:00.000
INV000247281	33	19.82273000000000000000	8.00000000000000000000	S	2025-04-09 08:03:00.000
INV000247282	25	19.82273000000000000000	3.00000000000000000000	S	2025-04-09 08:09:00.000
INV000301310	19	19.82273000000000000000	9.00000000000000000000	S	2025-04-09 10:58:00.000
INV000247283	3	19.82273000000000000000	2.00000000000000000000	S	2025-04-09 11:25:00.000
INV000306686	2	19.82273000000000000000	2.00000000000000000000	S	2025-04-09 11:42:00.000
INV000247306	41	19.82273000000000000000	9.00000000000000000000	S	2025-04-10 07:09:00.000
INV000247307	35	19.82273000000000000000	7.00000000000000000000	S	2025-04-10 08:01:00.000
INV000247319	39	19.82273000000000000000	2.00000000000000000000	S	2025-04-10 08:17:00.000
INV000247326	31	19.82273000000000000000	5.00000000000000000000	S	2025-04-10 08:22:00.000
INV000247317	43	19.82273000000000000000	10.00000000000000000000	S	2025-04-10 09:32:27.730
INV000306643	19	19.82273000000000000000	5.00000000000000000000	S	2025-04-10 09:55:22.370
INV000247379	43	19.82273000000000000000	6.00000000000000000000	S	2025-04-11 08:42:00.000
INV000247376	43	19.82273000000000000000	9.00000000000000000000	S	2025-04-11 08:48:15.240
INV000247382	51	19.82273000000000000000	12.00000000000000000000	S	2025-04-11 09:03:00.000
INV000247384	35	19.82273000000000000000	8.00000000000000000000	S	2025-04-11 09:22:00.000
INV000287025	31	19.82273000000000000000	1.00000000000000000000	S	2025-04-11 16:37:40.440"""

print("=" * 100)
print("NOTA: Este script es una DEMOSTRACIÓN del cálculo.")
print("Para generar el script completo, necesitas guardar TODOS los datos")
print("de entradas y salidas en archivos CSV y cargarlos aquí.")
print("=" * 100)
print()

# Cargar datos
df_entradas = pd.read_csv(StringIO(entradas_data), sep='\t')
df_salidas = pd.read_csv(StringIO(salidas_data), sep='\t')

# Convertir tipos
df_entradas['Costo_MN'] = pd.to_numeric(df_entradas['Costo_MN'])
df_entradas['Cantidad'] = pd.to_numeric(df_entradas['Cantidad'])
df_entradas['FechaMovimiento'] = pd.to_datetime(df_entradas['FechaMovimiento'])

df_salidas['Costo_MN'] = pd.to_numeric(df_salidas['Costo_MN'])
df_salidas['Cantidad'] = pd.to_numeric(df_salidas['Cantidad'])
df_salidas['FechaMovimiento'] = pd.to_datetime(df_salidas['FechaMovimiento'])

# Combinar y ordenar por fecha
df_entradas['Tipo'] = 'E'
df_salidas['Tipo'] = 'S'
df_all = pd.concat([df_entradas, df_salidas])
df_all = df_all.sort_values('FechaMovimiento').reset_index(drop=True)

# Recalcular costos con promedio ponderado
saldo_cantidad = 0.0
saldo_total = 0.0

correcciones = []

print(f"{'Fecha':<20} | {'Tipo':<4} | {'Cd_Inv':<15} | {'Item':<5} | {'Cant':<8} | {'Costo Actual':<14} | {'Costo Correcto':<14} | {'Diff':<10}")
print("-" * 120)

for idx, row in df_all.iterrows():
    tipo = row['Tipo']
    cantidad = row['Cantidad']
    costo_actual = row['Costo_MN']
    cd_inv = row['Cd_Inv']
    item = row['Item']
    fecha = row['FechaMovimiento']

    if tipo == 'E':
        # ENTRADA - actualizar saldo
        total_entrada = cantidad * costo_actual
        saldo_total += total_entrada
        saldo_cantidad += cantidad
        costo_promedio = saldo_total / saldo_cantidad if saldo_cantidad > 0 else 0
    else:
        # SALIDA - verificar si el costo es correcto
        costo_promedio = saldo_total / saldo_cantidad if saldo_cantidad > 0 else 0
        costo_correcto = costo_promedio

        diff = abs(costo_actual - costo_correcto)

        if diff > 0.01:
            print(f"{str(fecha)[:19]:<20} | {tipo:<4} | {cd_inv:<15} | {item:<5} | {cantidad:<8.2f} | {costo_actual:<14.5f} | {costo_correcto:<14.5f} | {diff:<+10.5f}")
            correcciones.append({
                'Cd_Inv': cd_inv,
                'Item': item,
                'Costo_Actual': costo_actual,
                'Costo_Correcto': costo_correcto,
                'Cantidad': cantidad,
                'Fecha': fecha
            })

        # Actualizar saldo después de la salida
        total_salida = cantidad * costo_promedio
        saldo_cantidad -= cantidad
        saldo_total -= total_salida

print()
print("=" * 100)
print(f"Total de correcciones necesarias: {len(correcciones)}")
print("=" * 100)

# Generar script SQL
if correcciones:
    with open(r'd:\nuvol\sp\UPDATE_CostoInventario_PD00489.sql', 'w', encoding='utf-8') as f:
        f.write("-- =====================================================\n")
        f.write("-- SCRIPT DE CORRECCIÓN DE COSTOS EN CostoInventario\n")
        f.write("-- Producto: PD00489\n")
        f.write(f"-- Generado: {datetime.now()}\n")
        f.write("-- =====================================================\n\n")
        f.write("USE [ERP_ECHA]\nGO\n\n")
        f.write("BEGIN TRANSACTION\n\n")

        for c in correcciones:
            f.write(f"-- Fecha: {c['Fecha']} | Cant: {c['Cantidad']:.2f} | Actual: {c['Costo_Actual']:.5f} -> Correcto: {c['Costo_Correcto']:.5f}\n")
            f.write(f"UPDATE CostoInventario\n")
            f.write(f"SET Costo_MN = {c['Costo_Correcto']:.10f}\n")
            f.write(f"WHERE RucE = '20102351038'\n")
            f.write(f"  AND Cd_Inv = '{c['Cd_Inv']}'\n")
            f.write(f"  AND Item = {c['Item']}\n")
            f.write(f"  AND IC_TipoCostoInventario = 'M';\n\n")

        f.write(f"\n-- Total de registros a actualizar: {len(correcciones)}\n\n")
        f.write("-- Si todo está correcto, ejecutar:\n")
        f.write("COMMIT TRANSACTION\n\n")
        f.write("-- Si hay errores, ejecutar:\n")
        f.write("-- ROLLBACK TRANSACTION\n")

    print(f"\nScript SQL generado: UPDATE_CostoInventario_PD00489.sql")
